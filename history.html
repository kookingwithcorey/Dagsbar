<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DAGS | Whiskey Log Book</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050608;
      --bg-alt: #11141a;
      --accent: #0f8b6b;
      --accent-soft: rgba(15, 139, 107, 0.3);
      --text: #f7f7f7;
      --muted: #a3acb9;
      --border: rgba(255, 255, 255, 0.12);
      --radius-lg: 18px;

      --blind-pill-bg: rgba(111, 66, 193, 0.18);
      --blind-pill-border: rgba(167, 139, 250, 0.9);
      --blind-pill-text: #c4b5fd;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #202735 0, #050608 55%);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .page {
      width: 100%;
      max-width: 1100px;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.18em;
      text-transform: uppercase;
    }

    .brand-subtitle {
      font-size: 0.8rem;
      text-transform: uppercase;
      color: var(--muted);
      letter-spacing: 0.28em;
    }

    nav {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    nav a {
      font-size: 0.85rem;
      text-decoration: none;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      transition: all 0.18s ease;
    }

    nav a:hover {
      border-color: var(--border);
      color: var(--text);
      background: rgba(255, 255, 255, 0.02);
    }

    nav a.active {
      border-color: var(--accent-soft);
      background: rgba(15, 139, 107, 0.12);
      color: var(--text);
    }

    .card {
      background: rgba(10, 12, 18, 0.92);
      border-radius: 24px;
      border: 1px solid var(--border);
      padding: 20px 20px 24px;
      box-shadow: 0 18px 80px rgba(0, 0, 0, 0.6);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "DAGS";
      position: absolute;
      right: 20px;
      bottom: 10px;
      font-size: 3.2rem;
      font-weight: 800;
      letter-spacing: 0.35em;
      color: rgba(255, 255, 255, 0.03);
      pointer-events: none;
      user-select: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.85rem;
      color: var(--muted);
      max-width: 520px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-end;
    }

    button,
    .btn-secondary {
      border-radius: 999px;
      padding: 8px 16px;
      border: 1px solid transparent;
      background: var(--accent);
      color: #fff;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.18s ease;
    }

    button:hover,
    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .btn-secondary {
      background: transparent;
      border-color: var(--border);
      color: var(--muted);
    }

    .btn-danger {
      background: transparent;
      border-color: rgba(255, 99, 99, 0.7);
      color: #ff9b9b;
    }

    .search-input {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 7px 14px;
      background: rgba(255, 255, 255, 0.02);
      color: var(--text);
      font-size: 0.85rem;
      min-width: 200px;
      outline: none;
    }

    .search-input::placeholder {
      color: var(--muted);
    }

    .search-input:focus {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(15, 139, 107, 0.3);
      background: rgba(0, 0, 0, 0.75);
    }

    select.filter-select {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 12px;
      font-size: 0.85rem;
      color: var(--text);
      outline: none;
    }

    select.filter-select option {
      background: #050608;
      color: var(--text);
    }

    .history-section-title {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .history-empty {
      font-size: 0.9rem;
      color: var(--muted);
      opacity: 0.85;
      margin-top: 6px;
    }

    .history-layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr);
      gap: 18px;
    }

    @media (max-width: 900px) {
      .history-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .history-list {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .history-item {
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.45);
      display: grid;
      grid-template-columns: auto minmax(0, 1fr);
      column-gap: 10px;
      row-gap: 4px;
      font-size: 0.85rem;
      align-items: flex-start;
    }

    .history-item:hover {
      border-color: rgba(15, 139, 107, 0.6);
      background: rgba(15, 139, 107, 0.08);
    }

    .history-item-main {
      display: grid;
      grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.2fr);
      column-gap: 16px;
      row-gap: 4px;
    }

    @media (max-width: 720px) {
      .history-item-main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .history-main-line {
      font-weight: 500;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: baseline;
    }

    .history-whiskey {
      font-size: 0.95rem;
    }

    .history-meta {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .history-notes {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .history-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 2px;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      padding: 1px 7px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .pill-rating {
      border-color: rgba(255, 180, 90, 0.7);
      color: #ffd29a;
    }

    .pill-type-tasting {
      border-color: rgba(15, 139, 107, 0.6);
      color: #9de5ce;
    }

    .pill-type-blind {
      border-color: var(--blind-pill-border);
      color: var(--blind-pill-text);
      background: var(--blind-pill-bg);
    }

    .history-right {
      text-align: right;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      font-size: 0.75rem;
    }

    .history-date {
      font-size: 0.78rem;
      color: var(--muted);
    }

    .history-flavors {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .small-label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      color: var(--muted);
      margin-bottom: 2px;
    }

    /* iOS-style circle checkbox */
    .select-wrapper {
      display: flex;
      align-items: center;
      padding-top: 4px;
    }

    .select-checkbox {
      position: relative;
      width: 18px;
      height: 18px;
      margin-right: 4px;
    }

    .select-checkbox input {
      opacity: 0;
      position: absolute;
      inset: 0;
      cursor: pointer;
    }

    .select-checkbox span {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: transparent;
      box-shadow: inset 0 0 0 2px transparent;
      transition: all 0.18s ease;
    }

    .select-checkbox input:checked + span {
      border-color: var(--accent-soft);
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(15, 139, 107, 0.5);
    }

    /* Detail panel */
    .detail-panel {
      border-radius: 18px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      padding: 12px 14px 14px;
      background: rgba(3, 6, 12, 0.92);
      display: none;
      font-size: 0.86rem;
    }

    .detail-panel.active {
      display: block;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .detail-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--muted);
    }

    .detail-form {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 8px;
    }

    .detail-row {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .detail-row label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
    }

    .detail-row input,
    .detail-row textarea {
      background: rgba(255, 255, 255, 0.02);
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 0.86rem;
      color: var(--text);
      outline: none;
    }

    .detail-row textarea {
      border-radius: 12px;
      min-height: 60px;
      resize: vertical;
    }

    .detail-row input:focus,
    .detail-row textarea:focus {
      border-color: var(--accent-soft);
      box-shadow: 0 0 0 1px rgba(15, 139, 107, 0.28);
      background: rgba(0, 0, 0, 0.75);
    }

    .detail-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .blind-breakdown {
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.4;
    }

    /* History flavor chart styling */
    #historyFlavorChartWrapper {
      margin-top: 12px;
      display: none;
    }

    #historyFlavorChartWrapper .section-title {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      color: #a3acb9;
      margin-bottom: 4px;
    }

    #historyFlavorChartWrapper .flavor-chart {
      position: relative;
      margin: 4px -4px 10px;
      padding: 0 4px 24px;
      overflow: hidden;
    }

    #historyFlavorChartWrapper svg {
      width: 100%;
      height: 150px;
      display: block;
    }

    #historyFlavorChartWrapper .profile-line {
      fill: none;
      stroke: #ff5f3b;
      stroke-width: 4;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    #historyFlavorChartWrapper .profile-guide {
      stroke: rgba(255, 255, 255, 0.18);
      stroke-width: 1;
      stroke-dasharray: 3 3;
    }

    #historyFlavorChartWrapper .profile-tick {
      stroke: rgba(255, 255, 255, 0.6);
      stroke-width: 1.4;
    }

    #historyFlavorChartWrapper .profile-point {
      r: 4;
      fill: #ff5f3b;
    }

    #historyFlavorChartWrapper .flavor-chart-labels {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: space-between;
      font-size: 0.62rem;
      text-transform: uppercase;
      letter-spacing: 0.11em;
      color: #a3acb9;
      pointer-events: none;
      padding: 0 4px;
    }

    #historyFlavorChartWrapper .flavor-chart-labels span {
      white-space: nowrap;
    }

    footer {
      margin-top: 14px;
      text-align: center;
      font-size: 0.75rem;
      color: var(--muted);
      opacity: 0.7;
    }

    @media print {
      body {
        background: #ffffff;
      }

      .page {
        max-width: 100%;
        padding: 0.4in;
      }

      header nav,
      .controls,
      .detail-panel {
        display: none !important;
      }

      .card {
        box-shadow: none;
        border-radius: 0;
        background: #ffffff;
        border-color: #dddddd;
      }

      .card::before {
        color: rgba(0, 0, 0, 0.04);
      }

      .history-item {
        background: #ffffff;
        border-color: #cccccc;
        cursor: default;
      }

      footer {
        color: #333333 !important;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div class="brand">
        <div class="brand-title">DAGS</div>
        <div class="brand-subtitle">Bourbon & Whiskey Lounge</div>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="menu.html">Whiskey List</a>
        <a href="menu-print.html">Printable Menu</a>
        <a href="tasting.html">Tasting Sheet</a>
        <a href="blind-tasting.html">Blind Tasting</a>
        <a href="history.html" class="active">Whiskey Log Book</a>
      </nav>
    </header>

    <main class="card">
      <div class="card-header">
        <div>
          <div class="card-title">Whiskey Log Book</div>
          <div class="card-subtitle">
            Every time you save a tasting or blind flight, it’s stored in your browser.
            Search, filter, multi-select, and click any entry to see details, edit, or delete.
          </div>
        </div>
        <div class="controls">
          <input
            id="historySearch"
            class="search-input"
            type="text"
            placeholder="Search whiskey, notes..."
          />
          <select id="typeFilter" class="filter-select">
            <option value="all">All Entries</option>
            <option value="tasting">Tasting Sheets Only</option>
            <option value="blind">Blind Tastings Only</option>
          </select>
          <button type="button" id="deleteSelectedBtn" class="btn-danger">Delete Selected</button>
          <button type="button" id="exportCsvBtn" class="btn-secondary">Export CSV</button>
          <button type="button" id="printBtn">Print</button>
        </div>
      </div>

      <section>
        <div class="history-section-title">Saved Entries</div>

        <div id="historyEmpty" class="history-empty" style="display:none;">
          No saved tastings yet. Go to the Tasting Sheet or Blind Tasting page, fill one out, and hit “Save”.
        </div>

        <div class="history-layout">
          <div>
            <div id="historyList" class="history-list"></div>
          </div>

          <!-- Detail / edit panel -->
          <aside id="detailPanel" class="detail-panel">
            <div class="detail-header">
              <div class="detail-title">Entry Details</div>
              <button type="button" id="closeDetailBtn" class="btn-secondary">Close</button>
            </div>
            <form id="detailForm" class="detail-form" autocomplete="off">
              <div class="detail-row">
                <label>Type</label>
                <input id="detailType" type="text" readonly />
              </div>
              <div class="detail-row">
                <label>Date</label>
                <input id="detailDate" type="text" readonly />
              </div>
              <div class="detail-row">
                <label>Whiskey / Title</label>
                <input id="detailWhiskey" type="text" />
              </div>
              <div class="detail-row">
                <label>Distillery / Brand</label>
                <input id="detailDistillery" type="text" />
              </div>
              <div class="detail-row">
                <label>Price</label>
                <input id="detailPrice" type="text" />
              </div>
              <div class="detail-row">
                <label>Rating</label>
                <input id="detailRating" type="text" />
              </div>
              <div class="detail-row">
                <label>Nose</label>
                <textarea id="detailNose"></textarea>
              </div>
              <div class="detail-row">
                <label>Palate</label>
                <textarea id="detailPalate"></textarea>
              </div>
              <div class="detail-row">
                <label>Finish</label>
                <textarea id="detailFinish"></textarea>
              </div>
              <div class="detail-row">
                <label>Other Notes</label>
                <textarea id="detailOther"></textarea>
              </div>

              <!-- Blind-only breakdown -->
              <div class="detail-row" id="blindBreakdownRow" style="display:none;">
                <label>Blind Bottles Summary</label>
                <div id="blindBreakdown" class="blind-breakdown"></div>
              </div>

              <!-- Flavor chart from tasting sheet -->
              <div id="historyFlavorChartWrapper">
                <div class="section-title">Flavor Profile (from Tasting Sheet)</div>
                <div class="flavor-chart">
                  <svg id="historyFlavorChart" viewBox="0 0 600 200" preserveAspectRatio="none"></svg>
                  <div class="flavor-chart-labels">
                    <span>Smoky</span>
                    <span>Spicy</span>
                    <span>Herbal</span>
                    <span>Full</span>
                    <span>Rich</span>
                    <span>Sweet</span>
                    <span>Vanilla</span>
                    <span>Creamy</span>
                    <span>Oaky</span>
                    <span>Tart</span>
                    <span>Fruity</span>
                    <span>Floral</span>
                  </div>
                </div>
              </div>

              <div class="detail-actions">
                <button type="button" id="saveChangesBtn">Save Changes</button>
                <button type="button" id="deleteEntryBtn" class="btn-danger">Delete Entry</button>
              </div>
            </form>
          </aside>
        </div>
      </section>

      <footer>
        DAGS Bourbon &amp; Whiskey Lounge &mdash; Log is stored locally in your browser (per device).
      </footer>
    </main>
  </div>

  <script>
    /* --- Shared flavor chart config for history detail --- */
    const historySliderConfig = [
      "smoky",
      "spicy",
      "herbal",
      "fullBody",
      "rich",
      "sweet",
      "vanilla",
      "creamy",
      "oaky",
      "tart",
      "fruity",
      "floral"
    ];

    function drawHistoryFlavorChart(flavorMetrics) {
      const svg = document.getElementById("historyFlavorChart");
      if (!svg) return;

      const width = 600;
      const height = 200;
      const topPad = 25;
      const bottomPad = 40;
      const usableHeight = height - topPad - bottomPad;
      const axisCount = historySliderConfig.length;
      const yBase = height - bottomPad;

      const points = [];

      for (let i = 0; i < axisCount; i++) {
        const x = (i / (axisCount - 1)) * width;
        const id = historySliderConfig[i];
        const value =
          flavorMetrics && flavorMetrics[id] != null ? Number(flavorMetrics[id]) : 0;
        const ratio = Math.max(0, Math.min(5, value)) / 5;
        const y = yBase - ratio * usableHeight;
        points.push({ x, y });
      }

      const pathD = points
        .map((p, i) => (i === 0 ? "M " : "L ") + p.x + " " + p.y)
        .join(" ");

      const guides = points
        .map(
          (p) =>
            `<line class="profile-guide" x1="${p.x}" y1="${yBase}" x2="${p.x}" y2="${p.y}"></line>`
        )
        .join("");

      const ticks = points
        .map(
          (p) =>
            `<line class="profile-tick" x1="${p.x}" y1="${yBase}" x2="${p.x}" y2="${
              yBase + 6
            }"></line>`
        )
        .join("");

      const circles = points
        .map(
          (p) =>
            `<circle class="profile-point" cx="${p.x}" cy="${p.y}"></circle>`
        )
        .join("");

      svg.innerHTML =
        `<path class="profile-line" d="${pathD}"></path>` +
        guides +
        ticks +
        circles;
    }

    /* --- Storage + state --- */
    const TASTING_HISTORY_KEY = "dags_tastings_v1";
    const BLIND_HISTORY_KEY = "dags_blind_tastings_v1";

    let tastingHistoryRaw = [];
    let blindHistoryRaw = [];
    let currentDetail = null; // { type: "tasting" | "blind", id: string }
    let searchQuery = "";

    function loadHistory(key) {
      try {
        return JSON.parse(localStorage.getItem(key) || "[]");
      } catch (e) {
        console.error("Error reading history", key, e);
        return [];
      }
    }

    function saveHistory() {
      localStorage.setItem(TASTING_HISTORY_KEY, JSON.stringify(tastingHistoryRaw));
      localStorage.setItem(BLIND_HISTORY_KEY, JSON.stringify(blindHistoryRaw));
    }

    function initHistory() {
      tastingHistoryRaw = loadHistory(TASTING_HISTORY_KEY);
      blindHistoryRaw = loadHistory(BLIND_HISTORY_KEY);
    }

    function combineHistory() {
      const t = tastingHistoryRaw.map((e) => ({ ...e, _type: "tasting" }));
      const b = blindHistoryRaw.map((e) => ({ ...e, _type: "blind" }));
      const all = [...t, ...b];

      all.sort((a, b) => {
        const da = new Date(a.createdAt || 0).getTime();
        const db = new Date(b.createdAt || 0).getTime();
        return db - da;
      });

      return all;
    }

    function formatDate(iso) {
      if (!iso) return "";
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleString(undefined, {
        year: "numeric",
        month: "short",
        day: "numeric",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function topFlavorPills(entry) {
      const flavors = entry.flavors || {};
      const entries = Object.entries(flavors);
      if (!entries.length) return [];

      const labelMap = {
        smoky: "Smoky",
        spicy: "Spicy",
        herbal: "Herbal",
        fullBody: "Full",
        rich: "Rich",
        sweet: "Sweet",
        vanilla: "Vanilla",
        creamy: "Creamy",
        oaky: "Oaky",
        tart: "Tart",
        fruity: "Fruity",
        floral: "Floral"
      };

      const sorted = entries
        .map(([id, val]) => ({ id, val: Number(val) || 0 }))
        .sort((a, b) => b.val - a.val)
        .filter((item) => item.val > 0);

      return sorted.slice(0, 3).map((item) => labelMap[item.id] || item.id);
    }

    /* --- Rendering --- */
    function renderHistory() {
      const container = document.getElementById("historyList");
      const emptyState = document.getElementById("historyEmpty");
      const filter = document.getElementById("typeFilter").value;

      const all = combineHistory();
      const q = searchQuery.trim().toLowerCase();

      const filtered = all.filter((entry) => {
        if (filter === "tasting" && entry._type !== "tasting") return false;
        if (filter === "blind" && entry._type !== "blind") return false;

        if (!q) return true;

        const fields = [
          entry.whiskeyName || "",
          entry.title || "",
          entry.distillery || "",
          entry.rating || "",
          entry.nose || "",
          entry.palate || "",
          entry.finish || "",
          entry.other || ""
        ]
          .join(" ")
          .toLowerCase();

        return fields.includes(q);
      });

      if (!filtered.length) {
        container.innerHTML = "";
        emptyState.style.display = "block";
        closeDetailPanel();
        return;
      }

      emptyState.style.display = "none";

      container.innerHTML = filtered
        .map((entry) => {
          const isBlind = entry._type === "blind";

          const whiskeyName = entry.whiskeyName || entry.title || "";
          const distillery = entry.distillery || "";
          const ratingText = entry.rating || "";
          const created = formatDate(entry.createdAt);

          const age = entry.age ? `${entry.age} yrs` : "";
          const proof = entry.proof ? `${entry.proof} proof` : "";
          const price = entry.price || "";

          const nose = entry.nose || "";
          const palate = entry.palate || "";
          const finish = entry.finish || "";
          const other = entry.other || "";

          const flavorLabels = topFlavorPills(entry);
          const flavorText = flavorLabels.length ? flavorLabels.join(" • ") : "";

          const firstLine = [distillery, age, proof].filter(Boolean).join(" • ");
          const secondaryLine = price ? `Price: ${price}` : "";

          const notesSnippet = [nose, palate, finish, other]
            .filter(Boolean)
            .join(" | ")
            .slice(0, 220);

          const labelText =
            whiskeyName || (isBlind ? "Blind Flight" : "Untitled Tasting");

          return `
            <article class="history-item" data-type="${entry._type}" data-id="${
            entry.id ?? ""
          }">
              <div class="select-wrapper">
                <label class="select-checkbox">
                  <input type="checkbox" class="history-select" data-type="${
                    entry._type
                  }" data-id="${entry.id ?? ""}">
                  <span></span>
                </label>
              </div>
              <div class="history-item-main history-click-area">
                <div>
                  <div class="history-main-line">
                    <span class="history-whiskey">${labelText}</span>
                  </div>
                  <div class="history-meta">
                    ${
                      firstLine || secondaryLine
                        ? firstLine || secondaryLine
                        : ""
                    }
                  </div>
                  <div class="history-notes">
                    ${
                      notesSnippet
                        ? `<span class="small-label">Notes:</span> ${notesSnippet}${
                            notesSnippet.length === 220 ? "…" : ""
                          }`
                        : ""
                    }
                  </div>
                  <div class="history-pill-row">
                    ${
                      ratingText
                        ? `<span class="pill pill-rating">${ratingText}</span>`
                        : ""
                    }
                    <span class="pill ${
                      isBlind ? "pill-type-blind" : "pill-type-tasting"
                    }">${isBlind ? "Blind Tasting" : "Tasting Sheet"}</span>
                  </div>
                </div>
                <div class="history-right">
                  <div class="history-date">${created}</div>
                  ${
                    flavorText
                      ? `
                  <div class="history-flavors">
                    <div class="small-label">Top Flavors</div>
                    <span>${flavorText}</span>
                  </div>`
                      : ""
                  }
                </div>
              </div>
            </article>
          `;
        })
        .join("");
    }

    function findEntry(type, id) {
      if (!id) return null;
      const arr = type === "blind" ? blindHistoryRaw : tastingHistoryRaw;
      return arr.find((e) => String(e.id) === String(id)) || null;
    }

    function openDetailPanel(type, id) {
      const entry = findEntry(type, id);
      if (!entry) return;

      currentDetail = { type, id: String(id) };

      const panel = document.getElementById("detailPanel");
      panel.classList.add("active");

      document.getElementById("detailType").value =
        type === "blind" ? "Blind Tasting" : "Tasting Sheet";
      document.getElementById("detailDate").value = formatDate(entry.createdAt);

      const whiskey = entry.whiskeyName || entry.title || "";
      document.getElementById("detailWhiskey").value = whiskey;
      document.getElementById("detailDistillery").value =
        entry.distillery || "";
      document.getElementById("detailPrice").value = entry.price || "";
      document.getElementById("detailRating").value = entry.rating || "";
      document.getElementById("detailNose").value = entry.nose || "";
      document.getElementById("detailPalate").value = entry.palate || "";
      document.getElementById("detailFinish").value = entry.finish || "";
      document.getElementById("detailOther").value = entry.other || "";

      // Blind breakdown view
      const blindRow = document.getElementById("blindBreakdownRow");
      const blindDiv = document.getElementById("blindBreakdown");
      if (type === "blind") {
        const raw = entry.other || "";
        const parts = raw
          .split("|")
          .map((s) => s.trim())
          .filter(Boolean);
        if (parts.length) {
          blindDiv.innerHTML = parts.map((p) => `<div>• ${p}</div>`).join("");
        } else {
          blindDiv.innerHTML = "<div>No bottle summary stored.</div>";
        }
        blindRow.style.display = "flex";
      } else {
        blindRow.style.display = "none";
        blindDiv.innerHTML = "";
      }

      // Tasting flavor chart (only if we have flavor data)
      const chartWrapper = document.getElementById("historyFlavorChartWrapper");
      if (
        type === "tasting" &&
        entry.flavors &&
        Object.keys(entry.flavors).length
      ) {
        chartWrapper.style.display = "block";
        drawHistoryFlavorChart(entry.flavors);
      } else {
        chartWrapper.style.display = "none";
        drawHistoryFlavorChart({}); // clear
      }
    }

    function closeDetailPanel() {
      const panel = document.getElementById("detailPanel");
      panel.classList.remove("active");
      currentDetail = null;
    }

    function saveDetailChanges() {
      if (!currentDetail) return;

      const { type, id } = currentDetail;
      const arr = type === "blind" ? blindHistoryRaw : tastingHistoryRaw;
      const entry = arr.find((e) => String(e.id) === String(id));
      if (!entry) return;

      const whiskey = document
        .getElementById("detailWhiskey")
        .value.trim();

      if (type === "blind") {
        entry.title = whiskey || entry.title || "Blind Flight";
      } else {
        entry.whiskeyName = whiskey;
      }

      entry.distillery = document
        .getElementById("detailDistillery")
        .value.trim();
      entry.price = document.getElementById("detailPrice").value.trim();
      entry.rating = document.getElementById("detailRating").value.trim();
      entry.nose = document.getElementById("detailNose").value.trim();
      entry.palate = document.getElementById("detailPalate").value.trim();
      entry.finish = document.getElementById("detailFinish").value.trim();
      entry.other = document.getElementById("detailOther").value.trim();

      saveHistory();
      renderHistory();
      openDetailPanel(type, id); // refresh detail + chart
    }

    function deleteCurrentEntry() {
      if (!currentDetail) return;

      const { type, id } = currentDetail;
      const arr = type === "blind" ? blindHistoryRaw : tastingHistoryRaw;

      if (
        !confirm(
          "Delete this entry from your Whiskey Log Book? This cannot be undone."
        )
      ) {
        return;
      }

      const newArr = arr.filter((e) => String(e.id) !== String(id));
      if (type === "blind") {
        blindHistoryRaw = newArr;
      } else {
        tastingHistoryRaw = newArr;
      }

      saveHistory();
      renderHistory();
      closeDetailPanel();
    }

    function deleteSelected() {
      const checks = Array.from(
        document.querySelectorAll(".history-select:checked")
      );
      if (!checks.length) {
        alert("Select at least one entry to delete.");
        return;
      }

      if (
        !confirm(
          `Delete ${checks.length} entr${
            checks.length === 1 ? "y" : "ies"
          } from your Whiskey Log Book? This cannot be undone.`
        )
      ) {
        return;
      }

      const toDelete = checks.map((c) => ({
        type: c.getAttribute("data-type"),
        id: c.getAttribute("data-id")
      }));

      toDelete.forEach(({ type, id }) => {
        if (type === "blind") {
          blindHistoryRaw = blindHistoryRaw.filter(
            (e) => String(e.id) !== String(id)
          );
        } else {
          tastingHistoryRaw = tastingHistoryRaw.filter(
            (e) => String(e.id) !== String(id)
          );
        }
      });

      saveHistory();
      renderHistory();
      closeDetailPanel();
    }

    function exportCsv() {
      const all = combineHistory();
      if (!all.length) {
        alert("No entries to export yet.");
        return;
      }

      const header = [
        "Type",
        "Created At",
        "Whiskey / Title",
        "Distillery",
        "Age",
        "Proof",
        "Price",
        "Rating",
        "Nose",
        "Palate",
        "Finish",
        "Other",
        "Smoky",
        "Spicy",
        "Herbal",
        "Full",
        "Rich",
        "Sweet",
        "Vanilla",
        "Creamy",
        "Oaky",
        "Tart",
        "Fruity",
        "Floral"
      ];

      const rows = all.map((entry) => {
        const f = entry.flavors || {};
        const row = [
          entry._type === "blind" ? "Blind" : "Tasting",
          entry.createdAt || "",
          entry.whiskeyName || entry.title || "",
          entry.distillery || "",
          entry.age || "",
          entry.proof || "",
          entry.price || "",
          entry.rating || "",
          entry.nose || "",
          entry.palate || "",
          entry.finish || "",
          entry.other || "",
          f.smoky ?? "",
          f.spicy ?? "",
          f.herbal ?? "",
          f.fullBody ?? "",
          f.rich ?? "",
          f.sweet ?? "",
          f.vanilla ?? "",
          f.creamy ?? "",
          f.oaky ?? "",
          f.tart ?? "",
          f.fruity ?? "",
          f.floral ?? ""
        ];

        return row
          .map((value) => {
            const str = String(value ?? "");
            if (str.includes('"') || str.includes(",") || str.includes("\n")) {
              return '"' + str.replace(/"/g, '""') + '"';
            }
            return str;
          })
          .join(",");
      });

      const csv = [header.join(","), ...rows].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "dags_whiskey_log_book.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* --- Event wiring --- */
    document
      .getElementById("typeFilter")
      .addEventListener("change", renderHistory);

    document
      .getElementById("historySearch")
      .addEventListener("input", (e) => {
        searchQuery = e.target.value || "";
        renderHistory();
      });

    document
      .getElementById("exportCsvBtn")
      .addEventListener("click", exportCsv);

    document
      .getElementById("printBtn")
      .addEventListener("click", () => window.print());

    document
      .getElementById("closeDetailBtn")
      .addEventListener("click", closeDetailPanel);

    document
      .getElementById("saveChangesBtn")
      .addEventListener("click", saveDetailChanges);

    document
      .getElementById("deleteEntryBtn")
      .addEventListener("click", deleteCurrentEntry);

    document
      .getElementById("deleteSelectedBtn")
      .addEventListener("click", deleteSelected);

    // Delegate click on history items to open detail, but ignore checkbox clicks
    document.getElementById("historyList").addEventListener("click", (e) => {
      const isCheckbox = e.target.classList.contains("history-select");
      if (isCheckbox) return;

      const clickArea = e.target.closest(".history-click-area");
      if (!clickArea) return;
      const item = clickArea.closest(".history-item");
      if (!item) return;

      const type = item.getAttribute("data-type");
      const id = item.getAttribute("data-id");
      if (!type || !id) return;
      openDetailPanel(type, id);
    });

    /* --- Init --- */
    initHistory();
    renderHistory();
  </script>
</body>
</html>
